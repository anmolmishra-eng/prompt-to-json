# Replace the section starting at line ~350 in generate.py with this:

        # 5. GENERATE PREVIEW FILE WITH HUGGING FACE + TRIPO AI
        try:
            from app.storage import upload_geometry

            glb_content = None

            # Try Hugging Face FIRST (FREE, unlimited)
            if settings.HUGGINGFACE_API_KEY or True:  # Works without key too
                from app.huggingface_3d_generator import generate_3d_with_huggingface
                logger.info("Trying Hugging Face (FREE, unlimited)...")
                glb_content = await generate_3d_with_huggingface(
                    request.prompt,
                    spec_json['dimensions'],
                    settings.HUGGINGFACE_API_KEY
                )

            # Try Tripo AI if Hugging Face fails (10 free/month)
            if not glb_content and settings.TRIPO_API_KEY:
                from app.tripo_3d_generator import generate_3d_with_tripo
                logger.info("Trying Tripo AI (10 free/month)...")
                glb_content = await generate_3d_with_tripo(
                    request.prompt,
                    spec_json['dimensions'],
                    settings.TRIPO_API_KEY
                )

            # Fallback to basic GLB if both fail
            if not glb_content:
                logger.info("All 3D services unavailable, using fallback geometry")
                glb_content = generate_mock_glb(spec_json)

            # Upload to Supabase storage
            preview_url = upload_geometry(spec_id, glb_content)
            logger.info(f"Preview uploaded: {preview_url}")

        except Exception as e:
            logger.warning(f"Preview generation failed, using local path: {e}")
            # Fallback to local file path
            local_preview_path = f"data/geometry_outputs/{spec_id}.glb"
            create_local_preview_file(spec_json, local_preview_path)
            preview_url = f"http://localhost:8000/static/geometry/{spec_id}.glb"
